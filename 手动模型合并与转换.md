### 准备工作

1. 确保机器有足够的内存加载完整模型（例如7B模型需要13-15G）以进行合并模型操作。
2. 务必确认基模型和下载的LoRA模型完整性，检查是否与[SHA256.md](https://github.com/ymcui/Chinese-LLaMA-Alpaca/blob/main/SHA256.md)所示的值一致，否则无法进行合并操作。原版LLaMA包含：`tokenizer.model`、`tokenizer_checklist.chk`、`consolidated.*.pth`、`params.json`
3. 主要依赖库如下（如果出问题就请安装以下指定版本）：
   - `torch`（1.10,1.12,1.13测试通过)
   - `transformers`（4.28.1测试通过）
   - `sentencepiece`（0.1.97测试通过）
   - `peft`（0.3.0dev测试通过）
   - python版本建议在3.9以上

```bash
pip install torch==1.13.1
pip install transformers
pip install sentencepiece
pip install git+https://github.com/huggingface/peft
```

*注意：本项目不对使用第三方（非Facebook官方）权重的合规性和正确性负责，例如HuggingFace模型库中的`decapoda-research/llama-7b-hf`（use at your own risk）。*


### Step 1: 将原版LLaMA模型转换为HF格式

请使用[🤗transformers](https://huggingface.co/docs/transformers/installation#install-from-source)提供的脚本[convert_llama_weights_to_hf.py](https://github.com/huggingface/transformers/blob/main/src/transformers/models/llama/convert_llama_weights_to_hf.py)，将原版LLaMA模型转换为HuggingFace格式。将原版LLaMA的`tokenizer.model`放在`--input_dir`指定的目录，其余文件放在`${input_dir}/${model_size}`下。执行以下命令后，`--output_dir`中将存放转换好的HF版权重。

```bash
python src/transformers/models/llama/convert_llama_weights_to_hf.py \
    --input_dir path_to_original_llama_root_dir \
    --model_size 7B \
    --output_dir path_to_original_llama_hf_dir
```

### Step 2: 合并LoRA权重，生成全量模型权重

这一步骤会对原版LLaMA模型（HF格式）扩充中文词表，合并LoRA权重并生成全量模型权重。此处可以选择输出PyTorch版本权重（`.pth`文件）或者输出HuggingFace版本权重（`.bin`文件）。

`.pth`文件可用于：

  - [使用llama.cpp工具进行量化和部署](https://github.com/ymcui/Chinese-LLaMA-Alpaca/wiki/llama.cpp量化部署)

`.bin`文件可用于：

  - [使用Transformers进行推理](https://github.com/ymcui/Chinese-LLaMA-Alpaca/wiki/使用Transformers推理)
  - [使用text-generation-webui搭建界面](https://github.com/ymcui/Chinese-LLaMA-Alpaca/wiki/使用text-generation-webui搭建界面)

注意，不同模型的合并方式不同。请阅读以下指南并严格按照步骤进行。

#### 单LoRA权重合并（适用于 Chinese-LLaMA, Chinese-LLaMA-Plus, Chinese-Alpaca）

执行以下命令：

```bash
python scripts/merge_llama_with_chinese_lora.py \
    --base_model path_to_original_llama_hf_dir \
    --lora_model path_to_chinese_llama_or_alpaca_lora \
    --output_type [pth|huggingface] \
    --output_dir path_to_output_dir 
```

参数说明：

- `--base_model`：存放HF格式的LLaMA模型权重和配置文件的目录（Step 1生成）
- `--lora_model`：中文LLaMA/Alpaca LoRA解压后文件所在目录，也可使用[🤗Model Hub模型调用名称](https://github.com/ymcui/Chinese-LLaMA-Alpaca/tree/main#model-hub)
- `--output_type`: 指定输出格式，可为`pth`或`huggingface`。若不指定，默认为`pth`
- `--output_dir`：指定保存全量模型权重的目录，默认为`./`
- （可选）`--offload_dir`：对于低内存用户需要指定一个offload缓存路径

#### 多LoRA权重合并（适用于Chinese-Alpaca-Plus）

合并Chinese-Alpaca-Plus需要提供两个LoRA权重，分别为Chinese-LLaMA-Plus-LoRA和Chinese-Alpaca-Plus-LoRA。执行以下命令完成合并：

```bash
python scripts/merge_llama_with_chinese_lora.py \
    --base_model path_to_original_llama_hf_dir \
    --lora_model path_to_chinese_llama_plus_lora,path_to_chinese_alpaca_plus_lora \
    --output_type [pth|huggingface] \
    --output_dir path_to_output_dir 
```

参数选项含义与单LoRA权重合并中的含义相同。
需要注意的是` --lora_model`参数后要提供两个lora_model的地址，用逗号分隔。

⚠️ **两个LoRA模型的顺序很重要，不能颠倒。先写LLaMA-Plus-LoRA然后写Alpaca-Plus-LoRA。** ⚠️

