我们这里给出Pre-training Stage 2的训练脚本[scripts/run_clm_pt_with_peft.py](https://github.com/ymcui/Chinese-LLaMA-Alpaca/blob/main/scripts/run_clm_pt_with_peft.py)。
Pre-training Stage 1中模型收敛速度较慢，如果不是有特别充裕的时间和计算资源，建议跳过该阶段。

脚本的启动命令如下（部分变量的值需由用户指定）：

```bash
data_cache=/path-to-data-cache
dataset_dir=/path-to-dataset
output_dir=/path-to-output
pretrained_model=/path-to-pretrained-model
chinese_tokenizer_path=/path-to-chinese-tokenizer

python scripts/run_clm_pt_with_peft.py \
    --model_name_or_path ${pretrained_model} \
    --tokenizer_name_or_path ${chinese_tokenizer_path} \
    --dataset_dir ${dataset_dir} \
    --data_cache_dir $data_cache \
    --output_dir ${output_dir} \
    --per_device_train_batch_size 2 \
    --per_device_eval_batch_size 2 \
    --gradient_accumulation_steps 8 \
    --max_steps 9000 \
    --learning_rate 2e-4 \
    --lora_rank 8 \
    --trainable "q_proj,v_proj" \
    --modules_to_save "embed_tokens" \
    --lora_dropout 0.05 \
    --validation_split_percentage 0.001 \
    --do_train \
    --seed $RANDOM \
    --fp16 \
    --lr_scheduler_type cosine \
    --warmup_ratio 0.05 \
    --weight_decay 0.01 \
    --logging_strategy steps \
    --logging_steps 10 \
    --save_strategy steps \
    --save_total_limit 3 \
    --save_steps 500 \
    --preprocessing_num_workers 8 \
    --block_size 512 \
    --overwrite_output_dir \
    --ddp_timeout 30000 \
    --logging_first_step True \
    --torch_dtype float16
```

其中一些参数的含义不言自明。部分参数的解释如下：
* `--model_name_or_path`: 原版LLaMA模型HuggingFace格式权重位置
* `--tokenizer_name_or_path`: Chinese-LLaMA tokenizer所在的目录
* `--dataset_dir`: 预训练数据的目录，可包含多个以`txt`结尾的纯文本文件
* `--data_cache_dir`: 指定一个存放数据缓存文件的目录


这里列出的超参数（尤其是学习率，以及和total batch size大小相关的参数）仅供参考。请在实际使用时根据数据情况以及硬件条件进行配置。

如要使用deepspeed，可自行添加参数 `--deepspeed ${path-to-deepspeed_config_file}`，以及改用torchrun进行启动:
```bash
torchrun \
  --nnodes ${num_nodes} \
  --nproc_per_node ${num_gpu_per_node} 
  --node_rank ${node_rank} \
  --master_addr ${master_addr} \
  --master_port ${master_port} \
  run_clm_pt_with_peft.py \
    --deepspeed ${path-to-deepspeed_config_file} \
    ...
```


### ⚠️重要提示⚠️

**因为Peft库变动频繁，该代码仅适用于特定Peft版本，请从源码安装[commit id为13e53fc的Peft](https://github.com/huggingface/peft/tree/13e53fc)。如果使用其他版本的Peft，不能保证模型可以正常训练**。


